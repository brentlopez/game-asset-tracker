# WARP.md

This file provides guidance to WARP when working with code in the `obsidian-plugin` subdirectory.

## Context

This is the Obsidian plugin component of the Game Asset Tracker system. **Always read `/ARCHITECTURE.md` at the repository root first** for the complete system design and data model.

## What This Plugin Does

Imports JSON manifests (generated by Python ingestion scripts) and:
1. **Updates SQLite database** with asset metadata for fast search
2. **Creates/updates Markdown notes** in the vault for human organization

This is the bridge between filesystem assets and Obsidian's knowledge management.

## Technology Stack

- **TypeScript** with React (TSX)
- **sql.js** - WASM SQLite for embedded database
- **esbuild** - Bundler with React/JSX support
- **Obsidian API** - Plugin framework

## Key Architecture Points

### Database Persistence
- sql.js is **in-memory** by default
- `DatabaseManager` implements manual persistence to `data.db`
- Database is loaded on plugin startup, saved after each import
- Uses Obsidian's `vault.adapter` for file I/O

### The Dual Action
Every manifest import performs TWO actions atomically:
1. Insert/update SQLite tables (`packs` and `assets`)
2. Create/update a Markdown note in the vault

Both must succeed or fail together.

### Schema Enforcement
All data **must** conform to the JSON Schema in `/ARCHITECTURE.md`. The TypeScript types in `src/types.ts` mirror this schema exactly.

## File Organization

```
src/
├── main.ts              # Plugin lifecycle, orchestrates imports
├── database.ts          # sql.js wrapper with persistence logic
├── DashboardView.tsx    # React UI (file picker, stats, test query)
├── types.ts             # TypeScript interfaces matching JSON schema
└── utils.ts             # Markdown note generation
```

## Development Commands

```bash
npm install          # Install dependencies
npm run dev          # Watch mode (rebuilds on file changes)
npm run build        # Production build
tsc --noEmit         # Type check without building
```

## Common Tasks

### Adding a Database Query
1. Add method to `DatabaseManager` class in `src/database.ts`
2. Use `this.db.exec()` for queries, `this.query()` for convenience
3. Remember to handle the case where `this.db` is null

### Modifying the Dashboard UI
1. Edit `src/DashboardView.tsx`
2. Use Obsidian CSS variables for theming (e.g., `var(--background-secondary)`)
3. React state updates trigger re-renders automatically

### Changing the Markdown Note Template
1. Edit functions in `src/utils.ts`
2. `generatePackNote()` is the main entry point
3. Keep frontmatter fields consistent with what the plugin expects

### Adding a New Command
1. Add `this.addCommand()` in `main.ts` → `onload()`
2. Commands appear in Obsidian's command palette

## Important Constraints

1. **Never skip database persistence** - Always call `this.database.save()` after mutations
2. **Validate JSON before import** - Check for required fields (pack_id, pack_name, assets)
3. **Use relative paths** - Assets store paths relative to pack root, not absolute
4. **Handle async properly** - Database operations are async, don't forget await
5. **sql.js WASM loading** - Currently loads from CDN, may need bundling for offline use

## Testing the Plugin

1. Build: `npm run build`
2. Copy `main.js` and `manifest.json` to vault's `.obsidian/plugins/game-asset-tracker/`
3. Enable in Obsidian settings
4. Use `example-manifest.json` for testing
5. Check Developer Console for errors

## Debugging Tips

- **Database issues**: Check if `data.db` exists in plugin directory
- **React errors**: Look for JSX syntax issues or missing imports
- **Import fails**: Validate JSON structure matches schema
- **SQL errors**: Use `console.log()` in DatabaseManager methods
- **WASM loading fails**: Check network requests in DevTools

## Integration with Other Components

### Python Ingestion Scripts (`/ingestion-scripts/`)
- Generate the JSON manifests this plugin consumes
- Must output valid JSON conforming to the schema

### JSON Schema (`/schemas/`)
- Reference for validation
- TypeScript types are derived from this

## Anti-Patterns to Avoid

❌ Don't load the entire database into memory for display (use queries)  
❌ Don't create Markdown notes without updating the database  
❌ Don't bypass the importManifest flow (always use the dual action)  
❌ Don't store absolute paths in the database (use relative paths)  
❌ Don't forget to call `database.save()` after modifications  

## Future Considerations

- Code block processor for `asset-tracker-view` blocks in notes
- Advanced search UI for querying assets
- Asset preview generation (thumbnails)
- Offline WASM bundling for sql.js
- Settings UI for configuring paths and behavior
